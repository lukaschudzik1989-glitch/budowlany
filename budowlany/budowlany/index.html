<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0f1923">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BudowlanyPRO">
<meta name="description" content="Profesjonalna aplikacja do wycen prac budowlano-wykoÅ„czeniowych">
<title>BudowlanyPRO</title>
<link rel="manifest" href="#" id="manifest-link">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<style>
:root {
  --ink: #0a0f14;
  --ink2: #141c24;
  --ink3: #1e2a38;
  --steel: #2a3a4e;
  --muted: #4a5f74;
  --dim: #7a92a8;
  --ghost: #a8bfcc;
  --pale: #d4e2ea;
  --snow: #f0f5f8;
  --white: #ffffff;
  --gold: #f0a500;
  --gold2: #ffc740;
  --lime: #3dd68c;
  --red: #ff4d6d;
  --blue: #4d9fff;
  --r: 12px;
  --r-sm: 8px;
  --r-lg: 20px;
  --r-xl: 28px;
  --shadow: 0 2px 12px rgba(0,0,0,0.3);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
  --transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  font-family: 'DM Sans', -apple-system, sans-serif;
  background: var(--ink);
  color: var(--white);
  min-height: 100vh;
  min-height: -webkit-fill-available;
  overflow-x: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#auth-screen {
  min-height: 100vh;
  display: flex; align-items: center; justify-content: center;
  padding: 24px;
  background: var(--ink);
  position: relative; overflow: hidden;
}

.auth-bg {
  position: absolute; inset: 0; overflow: hidden;
}
.auth-bg::before {
  content: '';
  position: absolute; top: -30%; left: -20%;
  width: 70vw; height: 70vw;
  background: radial-gradient(circle, rgba(240,165,0,0.12) 0%, transparent 70%);
  border-radius: 50%;
}
.auth-bg::after {
  content: '';
  position: absolute; bottom: -20%; right: -10%;
  width: 50vw; height: 50vw;
  background: radial-gradient(circle, rgba(77,159,255,0.08) 0%, transparent 70%);
  border-radius: 50%;
}

.auth-card {
  background: var(--ink2);
  border: 1px solid var(--steel);
  border-radius: var(--r-xl);
  padding: 40px 36px;
  width: 100%; max-width: 420px;
  position: relative; z-index: 1;
  box-shadow: var(--shadow-lg);
  animation: fadeUp 0.5s ease;
}

.auth-logo {
  text-align: center; margin-bottom: 32px;
}
.auth-logo-icon {
  width: 64px; height: 64px;
  background: linear-gradient(135deg, var(--gold), var(--gold2));
  border-radius: 18px;
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 30px; margin-bottom: 14px;
  box-shadow: 0 8px 24px rgba(240,165,0,0.3);
}
.auth-logo h1 {
  font-family: 'Syne', sans-serif;
  font-size: 26px; font-weight: 800;
  color: var(--white); letter-spacing: -0.5px;
}
.auth-logo h1 span { color: var(--gold); }
.auth-logo p { color: var(--dim); font-size: 13px; margin-top: 4px; }

.auth-tabs {
  display: grid; grid-template-columns: 1fr 1fr;
  background: var(--ink3); border-radius: var(--r-sm);
  padding: 3px; margin-bottom: 24px;
}
.auth-tab {
  padding: 10px; text-align: center; cursor: pointer;
  border-radius: 6px; font-size: 14px; font-weight: 600;
  color: var(--dim); transition: var(--transition); border: none; background: none; color: var(--dim);
}
.auth-tab.active { background: var(--steel); color: var(--white); }

.form-group { margin-bottom: 16px; }
.form-label {
  display: block; font-size: 11px; font-weight: 600;
  color: var(--ghost); margin-bottom: 6px;
  text-transform: uppercase; letter-spacing: 0.8px;
}
.form-input {
  width: 100%; padding: 12px 14px;
  background: var(--ink3); border: 1.5px solid var(--steel);
  border-radius: var(--r-sm); color: var(--white);
  font-size: 15px; font-family: inherit;
  transition: var(--transition); outline: none;
}
.form-input:focus { border-color: var(--gold); background: var(--ink2); box-shadow: 0 0 0 3px rgba(240,165,0,0.1); }
.form-input::placeholder { color: var(--muted); }

.btn-primary {
  width: 100%; padding: 14px;
  background: linear-gradient(135deg, var(--gold), var(--gold2));
  border: none; border-radius: var(--r-sm);
  color: var(--ink); font-size: 15px; font-weight: 700;
  cursor: pointer; transition: var(--transition);
  font-family: inherit; letter-spacing: 0.3px;
  box-shadow: 0 4px 16px rgba(240,165,0,0.3);
}
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(240,165,0,0.4); }
.btn-primary:active { transform: translateY(0); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.auth-divider {
  text-align: center; color: var(--muted); font-size: 12px;
  margin: 20px 0; position: relative;
}
.auth-divider::before, .auth-divider::after {
  content: ''; position: absolute; top: 50%;
  width: 38%; height: 1px; background: var(--steel);
}
.auth-divider::before { left: 0; }
.auth-divider::after { right: 0; }

.demo-btn {
  width: 100%; padding: 12px;
  background: transparent; border: 1.5px solid var(--steel);
  border-radius: var(--r-sm); color: var(--ghost);
  font-size: 14px; font-weight: 600; cursor: pointer;
  transition: var(--transition); font-family: inherit;
}
.demo-btn:hover { border-color: var(--gold); color: var(--gold); }

.auth-info {
  margin-top: 20px; padding: 14px;
  background: rgba(240,165,0,0.06); border: 1px solid rgba(240,165,0,0.15);
  border-radius: var(--r-sm); font-size: 12px; color: var(--dim); line-height: 1.6;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app { display: none; flex-direction: column; min-height: 100vh; }

/* TOP BAR */
.topbar {
  background: var(--ink2);
  border-bottom: 1px solid var(--steel);
  padding: 14px 20px;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 100;
  padding-top: max(14px, env(safe-area-inset-top));
}
.topbar-logo {
  font-family: 'Syne', sans-serif;
  font-size: 18px; font-weight: 800; color: var(--white);
  display: flex; align-items: center; gap: 8px;
}
.topbar-logo span { color: var(--gold); }
.topbar-logo .logo-badge {
  background: linear-gradient(135deg, var(--gold), var(--gold2));
  width: 30px; height: 30px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
}
.topbar-right { display: flex; align-items: center; gap: 10px; }
.sync-badge {
  background: var(--ink3); border: 1px solid var(--steel);
  padding: 4px 10px; border-radius: 20px;
  font-size: 11px; color: var(--dim); display: flex; align-items: center; gap: 5px;
}
.sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--lime); animation: pulse 2s infinite; }
.user-avatar {
  width: 34px; height: 34px; border-radius: 50%;
  background: linear-gradient(135deg, var(--gold), var(--gold2));
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700; color: var(--ink);
  cursor: pointer; border: none; font-family: inherit;
}

/* PAGE CONTENT */
#page-content { flex: 1; padding: 20px 16px; padding-bottom: 90px; overflow-y: auto; }

/* BOTTOM NAV */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--ink2);
  border-top: 1px solid var(--steel);
  display: flex;
  padding-bottom: max(12px, env(safe-area-inset-bottom));
  z-index: 100;
}
.nav-item {
  flex: 1; padding: 10px 4px;
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  cursor: pointer; border: none; background: none;
  color: var(--muted); font-family: inherit; transition: var(--transition);
  -webkit-tap-highlight-color: transparent;
}
.nav-item .nav-icon { font-size: 22px; transition: var(--transition); }
.nav-item .nav-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.nav-item.active { color: var(--gold); }
.nav-item.active .nav-icon { transform: translateY(-2px); }
.nav-fab {
  flex: 1; padding: 4px 4px 0;
  display: flex; flex-direction: column; align-items: center;
  cursor: pointer; border: none; background: none; font-family: inherit;
  -webkit-tap-highlight-color: transparent;
}
.nav-fab-btn {
  width: 52px; height: 52px;
  background: linear-gradient(135deg, var(--gold), var(--gold2));
  border-radius: 16px; display: flex; align-items: center; justify-content: center;
  font-size: 24px; transform: translateY(-10px);
  box-shadow: 0 4px 20px rgba(240,165,0,0.4);
  transition: var(--transition);
}
.nav-fab:active .nav-fab-btn { transform: translateY(-8px) scale(0.96); }
.nav-fab .nav-label { font-size: 9px; font-weight: 600; color: var(--gold); text-transform: uppercase; letter-spacing: 0.5px; margin-top: -6px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CARDS & COMPONENTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--ink2);
  border: 1px solid var(--steel);
  border-radius: var(--r-lg);
  overflow: hidden;
}
.card-header {
  padding: 16px 18px 14px;
  border-bottom: 1px solid var(--steel);
  display: flex; align-items: center; justify-content: space-between;
}
.card-title {
  font-family: 'Syne', sans-serif;
  font-size: 15px; font-weight: 700; color: var(--white);
}
.card-body { padding: 18px; }

/* STAT CARDS */
.stats-scroll {
  display: flex; gap: 12px; overflow-x: auto;
  padding-bottom: 4px; margin-bottom: 20px;
  scrollbar-width: none;
}
.stats-scroll::-webkit-scrollbar { display: none; }
.stat-card {
  background: var(--ink2); border: 1px solid var(--steel);
  border-radius: var(--r-lg); padding: 18px 20px;
  min-width: 160px; flex-shrink: 0; position: relative; overflow: hidden;
}
.stat-card::after {
  content: ''; position: absolute; bottom: -20px; right: -10px;
  font-size: 60px; opacity: 0.05; line-height: 1;
}
.stat-card.gold { border-color: rgba(240,165,0,0.3); background: rgba(240,165,0,0.04); }
.stat-card.lime { border-color: rgba(61,214,140,0.3); background: rgba(61,214,140,0.04); }
.stat-card.blue { border-color: rgba(77,159,255,0.3); background: rgba(77,159,255,0.04); }
.stat-label { font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; }
.stat-value { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; margin: 6px 0 2px; }
.stat-card.gold .stat-value { color: var(--gold); }
.stat-card.lime .stat-value { color: var(--lime); }
.stat-card.blue .stat-value { color: var(--blue); }
.stat-sub { font-size: 11px; color: var(--muted); }

/* QUOTE LIST ITEMS */
.quote-item {
  background: var(--ink2); border: 1px solid var(--steel);
  border-radius: var(--r); padding: 16px;
  margin-bottom: 10px; cursor: pointer;
  transition: var(--transition); position: relative; overflow: hidden;
}
.quote-item:hover, .quote-item:active { border-color: var(--gold); background: rgba(240,165,0,0.03); }
.quote-item-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.quote-number { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; color: var(--white); }
.quote-amount { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 800; color: var(--gold); }
.quote-client { font-size: 13px; color: var(--ghost); margin-bottom: 10px; }
.quote-bottom { display: flex; justify-content: space-between; align-items: center; }
.quote-date { font-size: 11px; color: var(--muted); }

/* BADGES */
.badge { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.badge-robocza { background: rgba(122,146,168,0.15); color: var(--ghost); border: 1px solid rgba(122,146,168,0.3); }
.badge-wysÅ‚ana { background: rgba(77,159,255,0.15); color: var(--blue); border: 1px solid rgba(77,159,255,0.3); }
.badge-zaakceptowana { background: rgba(61,214,140,0.15); color: var(--lime); border: 1px solid rgba(61,214,140,0.3); }
.badge-odrzucona { background: rgba(255,77,109,0.15); color: var(--red); border: 1px solid rgba(255,77,109,0.3); }

/* SECTION BLOCKS */
.section-block { margin-bottom: 14px; border-radius: var(--r); overflow: hidden; border: 1px solid var(--steel); }
.section-header {
  background: var(--ink3); padding: 13px 16px;
  display: flex; align-items: center; justify-content: space-between;
  cursor: pointer; user-select: none;
}
.section-header-left { display: flex; align-items: center; gap: 10px; }
.section-header h3 { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: var(--white); }
.section-total-badge { background: rgba(240,165,0,0.15); color: var(--gold); border: 1px solid rgba(240,165,0,0.3); padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
.section-body { background: var(--ink2); }
.section-row { padding: 12px 16px; border-bottom: 1px solid var(--steel); display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
.section-row:last-child { border-bottom: none; }
.section-row-name { font-size: 13px; color: var(--ghost); }
.section-row-inputs { display: flex; gap: 8px; align-items: center; }
.section-input {
  width: 72px; padding: 8px 10px;
  background: var(--ink3); border: 1.5px solid var(--steel);
  border-radius: var(--r-sm); color: var(--white); font-size: 13px;
  text-align: right; font-family: inherit; outline: none;
  transition: var(--transition);
}
.section-input:focus { border-color: var(--gold); }
.section-row-total { font-size: 13px; font-weight: 700; color: var(--gold); min-width: 70px; text-align: right; }
.section-unit { font-size: 10px; color: var(--muted); text-align: center; width: 22px; }

/* SUMMARY BOX */
.summary-box {
  background: linear-gradient(135deg, var(--ink3), var(--steel));
  border: 1px solid rgba(240,165,0,0.2);
  border-radius: var(--r-lg); padding: 20px;
  position: relative; overflow: hidden;
}
.summary-box::before {
  content: ''; position: absolute; top: -30px; right: -30px;
  width: 120px; height: 120px;
  background: radial-gradient(circle, rgba(240,165,0,0.1) 0%, transparent 70%);
}
.sum-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
.sum-label { font-size: 13px; color: var(--dim); }
.sum-value { font-size: 14px; font-weight: 600; color: var(--white); }
.sum-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 10px 0; }
.sum-total { display: flex; justify-content: space-between; align-items: center; padding: 10px 0 0; }
.sum-total-label { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 800; color: var(--white); }
.sum-total-value { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; color: var(--gold); }

/* PARAMS ROW */
.params-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.param-box { background: var(--ink3); border: 1.5px solid var(--steel); border-radius: var(--r-sm); padding: 10px 12px; }
.param-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; font-weight: 600; }
.param-input {
  width: 100%; background: none; border: none; outline: none;
  color: var(--gold); font-size: 18px; font-weight: 700;
  font-family: 'Syne', sans-serif; text-align: center;
}

/* BUTTONS */
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; border-radius: var(--r-sm); font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: var(--transition); font-family: inherit; white-space: nowrap; }
.btn-gold { background: linear-gradient(135deg, var(--gold), var(--gold2)); color: var(--ink); box-shadow: 0 4px 16px rgba(240,165,0,0.3); }
.btn-gold:hover { box-shadow: 0 6px 20px rgba(240,165,0,0.4); transform: translateY(-1px); }
.btn-ghost { background: var(--ink3); border: 1.5px solid var(--steel); color: var(--ghost); }
.btn-ghost:hover { border-color: var(--gold); color: var(--gold); }
.btn-red { background: rgba(255,77,109,0.15); border: 1px solid rgba(255,77,109,0.3); color: var(--red); }
.btn-lime { background: rgba(61,214,140,0.15); border: 1px solid rgba(61,214,140,0.3); color: var(--lime); }
.btn-full { width: 100%; }
.btn-sm { padding: 8px 14px; font-size: 12px; border-radius: 6px; }

/* MODAL */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 500; display: flex; align-items: flex-end; justify-content: center;
  backdrop-filter: blur(6px); animation: fadeIn 0.15s;
}
.modal-overlay.center { align-items: center; padding: 20px; }
.modal {
  background: var(--ink2); border: 1px solid var(--steel);
  border-radius: var(--r-xl) var(--r-xl) 0 0;
  width: 100%; max-width: 540px; max-height: 90vh;
  display: flex; flex-direction: column;
  animation: slideUp 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  padding-bottom: max(20px, env(safe-area-inset-bottom));
}
.modal.center-modal { border-radius: var(--r-xl); max-height: 80vh; }
.modal-handle { width: 36px; height: 4px; background: var(--steel); border-radius: 2px; margin: 12px auto 0; flex-shrink: 0; }
.modal-header { padding: 16px 20px; border-bottom: 1px solid var(--steel); flex-shrink: 0; }
.modal-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; }
.modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 16px 20px; border-top: 1px solid var(--steel); display: flex; gap: 10px; flex-shrink: 0; }

/* SEARCH */
.search-box {
  display: flex; align-items: center; gap: 10px;
  background: var(--ink2); border: 1.5px solid var(--steel);
  border-radius: var(--r); padding: 10px 14px; margin-bottom: 16px;
}
.search-box input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--white); font-size: 15px; font-family: inherit;
}
.search-box input::placeholder { color: var(--muted); }
.search-icon { font-size: 18px; }

/* SELECT */
.form-select {
  width: 100%; padding: 12px 14px;
  background: var(--ink3); border: 1.5px solid var(--steel);
  border-radius: var(--r-sm); color: var(--white);
  font-size: 15px; font-family: inherit;
  transition: var(--transition); outline: none; cursor: pointer;
}
.form-select:focus { border-color: var(--gold); }

/* FILTER CHIPS */
.filter-chips { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 16px; padding-bottom: 4px; scrollbar-width: none; }
.filter-chips::-webkit-scrollbar { display: none; }
.chip {
  padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
  white-space: nowrap; cursor: pointer; border: 1.5px solid var(--steel);
  background: transparent; color: var(--dim); transition: var(--transition); font-family: inherit;
}
.chip.active { background: var(--gold); border-color: var(--gold); color: var(--ink); }

/* CLIENT ITEM */
.client-item {
  background: var(--ink2); border: 1px solid var(--steel);
  border-radius: var(--r); padding: 14px 16px;
  margin-bottom: 10px; display: flex; align-items: center; gap: 14px;
  cursor: pointer; transition: var(--transition);
}
.client-item:hover { border-color: var(--gold); }
.client-avatar {
  width: 44px; height: 44px; border-radius: 12px; flex-shrink: 0;
  background: linear-gradient(135deg, var(--steel), var(--ink3));
  display: flex; align-items: center; justify-content: center;
  font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; color: var(--gold);
  border: 1px solid rgba(240,165,0,0.2);
}
.client-info { flex: 1; min-width: 0; }
.client-name { font-weight: 600; color: var(--white); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.client-contact { font-size: 12px; color: var(--dim); margin-top: 2px; }
.client-stats { text-align: right; flex-shrink: 0; }
.client-count { font-size: 11px; color: var(--muted); }
.client-total { font-size: 13px; font-weight: 700; color: var(--gold); }

/* SETTINGS */
.settings-item {
  background: var(--ink2); border: 1px solid var(--steel);
  border-radius: var(--r); padding: 14px 16px;
  display: flex; align-items: center; gap: 14px;
  margin-bottom: 10px; cursor: pointer; transition: var(--transition);
}
.settings-item:hover { border-color: var(--steel); background: var(--ink3); }
.settings-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
.settings-info { flex: 1; }
.settings-title { font-size: 14px; font-weight: 600; color: var(--white); }
.settings-sub { font-size: 12px; color: var(--dim); margin-top: 2px; }
.settings-arrow { color: var(--muted); font-size: 16px; }

/* PAGE HEADER */
.page-header { margin-bottom: 20px; }
.page-title { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; color: var(--white); }
.page-sub { font-size: 13px; color: var(--dim); margin-top: 4px; }

/* DIVIDER */
.divider { height: 1px; background: var(--steel); margin: 16px 0; }
.section-label { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; margin-top: 20px; }

/* EMPTY */
.empty { text-align: center; padding: 60px 20px; }
.empty-icon { font-size: 52px; margin-bottom: 12px; }
.empty h3 { font-family: 'Syne', sans-serif; font-size: 18px; color: var(--ghost); margin-bottom: 6px; }
.empty p { font-size: 13px; color: var(--muted); }

/* CUSTOM ITEMS */
.custom-row { display: grid; grid-template-columns: 1fr 64px 64px 64px 32px; gap: 6px; padding: 10px 0; border-bottom: 1px solid var(--steel); align-items: center; }
.custom-row:last-child { border-bottom: none; }
.ci { width: 100%; padding: 8px 10px; background: var(--ink3); border: 1.5px solid var(--steel); border-radius: var(--r-sm); color: var(--white); font-size: 12px; font-family: inherit; outline: none; }
.ci:focus { border-color: var(--gold); }
.ci-del { background: none; border: none; color: var(--red); font-size: 18px; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; }

/* TOAST */
#toast-wrap { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; width: 90%; max-width: 360px; }
.toast-item { background: var(--ink2); border: 1px solid var(--steel); padding: 12px 16px; border-radius: var(--r); font-size: 13px; font-weight: 500; box-shadow: var(--shadow-lg); display: flex; gap: 10px; align-items: center; animation: slideDown 0.3s ease; }
.toast-item.success { border-color: rgba(61,214,140,0.4); }
.toast-item.error { border-color: rgba(255,77,109,0.4); }

/* PDF PAGE */
#pdf-overlay { display: none; position: fixed; inset: 0; background: var(--ink); z-index: 900; overflow-y: auto; }
.pdf-toolbar { background: var(--ink2); border-bottom: 1px solid var(--steel); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; }
.pdf-page { background: white; max-width: 800px; margin: 20px auto; padding: 40px; font-family: 'Segoe UI', sans-serif; color: #1a1a2e; border-radius: 12px; box-shadow: var(--shadow-lg); }

/* LOADER */
.loader { display: flex; align-items: center; justify-content: center; padding: 40px; }
.spinner { width: 36px; height: 36px; border: 3px solid var(--steel); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }

/* ANIMATIONS */
@keyframes fadeUp { from { opacity: 0; transform: translateY(24px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

/* DESKTOP */
@media (min-width: 768px) {
  #page-content { padding: 28px 32px; padding-bottom: 40px; max-width: 900px; margin: 0 auto; }
  .bottom-nav { display: none; }
  .topbar { padding: 16px 32px; }
  .desktop-nav { display: flex !important; }
}
.desktop-nav { display: none; align-items: center; gap: 4px; }
.desktop-nav-item { padding: 8px 14px; border-radius: var(--r-sm); font-size: 13px; font-weight: 600; color: var(--dim); cursor: pointer; border: none; background: none; font-family: inherit; transition: var(--transition); }
.desktop-nav-item:hover { color: var(--white); background: var(--ink3); }
.desktop-nav-item.active { color: var(--gold); background: rgba(240,165,0,0.1); }

@media print {
  body > *:not(#pdf-overlay) { display: none !important; }
  #pdf-overlay { display: block !important; position: static; background: white; }
  .pdf-toolbar { display: none; }
  .pdf-page { box-shadow: none; margin: 0; border-radius: 0; max-width: 100%; padding: 20px; }
}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-bg"></div>
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-icon">ğŸ—ï¸</div>
      <h1>Budowlany<span>PRO</span></h1>
      <p>System wycen budowlano-wykoÅ„czeniowych</p>
    </div>

    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Logowanie</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Rejestracja</button>
    </div>

    <div id="login-form">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="login-email" type="email" placeholder="twoj@email.pl" value="demo@budowlanypro.pl">
      </div>
      <div class="form-group">
        <label class="form-label">HasÅ‚o</label>
        <input class="form-input" id="login-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value="demo1234">
      </div>
      <button class="btn-primary" onclick="doLogin()" id="login-btn">Zaloguj siÄ™ â†’</button>
      <div class="auth-divider">lub</div>
      <button class="demo-btn" onclick="demoLogin()">ğŸš€ Tryb Demo (bez rejestracji)</button>
    </div>

    <div id="register-form" style="display:none">
      <div class="form-group">
        <label class="form-label">Nazwa Firmy</label>
        <input class="form-input" id="reg-company" type="text" placeholder="Twoja Firma Budowlana">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="reg-email" type="email" placeholder="twoj@email.pl">
      </div>
      <div class="form-group">
        <label class="form-label">HasÅ‚o</label>
        <input class="form-input" id="reg-pass" type="password" placeholder="min. 8 znakÃ³w">
      </div>
      <button class="btn-primary" onclick="doRegister()" id="reg-btn">UtwÃ³rz konto â†’</button>
    </div>

    <div class="auth-info">
      ğŸ’¡ <strong>Dane synchronizowane</strong> miÄ™dzy telefonem a komputerem. DziaÅ‚a offline â€” dane zapisywane lokalnie i synchronizowane przy poÅ‚Ä…czeniu.
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-logo">
      <div class="logo-badge">ğŸ—ï¸</div>
      Budowlany<span>PRO</span>
    </div>
    <nav class="desktop-nav" id="desktop-nav">
      <button class="desktop-nav-item active" onclick="showPage('dashboard')" data-page="dashboard">Dashboard</button>
      <button class="desktop-nav-item" onclick="showPage('quotes')" data-page="quotes">Wyceny</button>
      <button class="desktop-nav-item" onclick="showPage('clients')" data-page="clients">Klienci</button>
      <button class="desktop-nav-item" onclick="showPage('pricing')" data-page="pricing">Cennik</button>
      <button class="desktop-nav-item" onclick="showPage('settings')" data-page="settings">Ustawienia</button>
    </nav>
    <div class="topbar-right">
      <div class="sync-badge"><div class="sync-dot"></div><span id="sync-label">Online</span></div>
      <button class="user-avatar" onclick="showUserMenu()" id="user-avatar-btn">?</button>
    </div>
  </div>

  <!-- PAGE -->
  <div id="page-content"></div>

  <!-- BOTTOM NAV (mobile) -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="showPage('dashboard')" data-page="dashboard">
      <span class="nav-icon">ğŸ“Š</span><span class="nav-label">Wyniki</span>
    </button>
    <button class="nav-item" onclick="showPage('quotes')" data-page="quotes">
      <span class="nav-icon">ğŸ“‹</span><span class="nav-label">Wyceny</span>
    </button>
    <button class="nav-fab" onclick="showPage('new-quote')">
      <div class="nav-fab-btn">âœï¸</div>
      <span class="nav-label">Nowa</span>
    </button>
    <button class="nav-item" onclick="showPage('clients')" data-page="clients">
      <span class="nav-icon">ğŸ‘¥</span><span class="nav-label">Klienci</span>
    </button>
    <button class="nav-item" onclick="showPage('settings')" data-page="settings">
      <span class="nav-icon">âš™ï¸</span><span class="nav-label">WiÄ™cej</span>
    </button>
  </nav>
</div>

<!-- PDF OVERLAY -->
<div id="pdf-overlay">
  <div class="pdf-toolbar">
    <div style="font-family:'Syne',sans-serif;font-weight:700;color:white">ğŸ“„ PodglÄ…d PDF</div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-gold btn-sm" onclick="window.print()">ğŸ–¨ï¸ Drukuj / Zapisz PDF</button>
      <button class="btn btn-ghost btn-sm" onclick="closePDF()">âœ• Zamknij</button>
    </div>
  </div>
  <div id="pdf-content"></div>
</div>

<!-- TOAST -->
<div id="toast-wrap"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE (localStorage z sync-ready strukturÄ…)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB = {
  get: k => { try { return JSON.parse(localStorage.getItem('bp_'+k)||'null'); } catch { return null; } },
  set: (k,v) => localStorage.setItem('bp_'+k, JSON.stringify(v)),
  arr: k => DB.get(k) || [],
  save: (k,v) => DB.set(k,v)
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;

function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='register')));
  document.getElementById('login-form').style.display = tab==='login'?'':'none';
  document.getElementById('register-form').style.display = tab==='register'?'':'none';
}

function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-pass').value;
  if (!email||!pass) { toast('WypeÅ‚nij wszystkie pola','error'); return; }
  const users = DB.arr('users');
  const user = users.find(u => u.email===email && u.pass===btoa(pass));
  if (!user) { toast('BÅ‚Ä™dny email lub hasÅ‚o','error'); return; }
  loginUser(user);
}

function doRegister() {
  const company = document.getElementById('reg-company').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass = document.getElementById('reg-pass').value;
  if (!company||!email||!pass) { toast('WypeÅ‚nij wszystkie pola','error'); return; }
  if (pass.length<6) { toast('HasÅ‚o min. 6 znakÃ³w','error'); return; }
  const users = DB.arr('users');
  if (users.find(u=>u.email===email)) { toast('Ten email jest juÅ¼ zarejestrowany','error'); return; }
  const user = { id: genId(), email, pass: btoa(pass), company, created: today() };
  users.push(user);
  DB.save('users', users);
  // Init company settings for user
  DB.set('company_'+user.id, {
    name: company, nip:'', address:'', phone:'', email,
    website:'', bankAccount:'', logo:'', theme:'#f0a500',
    vat:23, footer:'DziÄ™kujemy za zaufanie! Zapraszamy do wspÃ³Å‚pracy.'
  });
  initDefaultPricing(user.id);
  toast('Konto utworzone!','success');
  loginUser(user);
}

function demoLogin() {
  const users = DB.arr('users');
  let demo = users.find(u=>u.email==='demo@budowlanypro.pl');
  if (!demo) {
    demo = { id:'demo', email:'demo@budowlanypro.pl', pass: btoa('demo1234'), company:'Demo Firma Budowlana', created: today() };
    users.push(demo);
    DB.save('users',users);
    DB.set('company_demo', {
      name:'Demo Firma Budowlana Sp. z o.o.', nip:'123-456-78-90',
      address:'ul. PrzykÅ‚adowa 12, 00-001 Warszawa',
      phone:'+48 500 123 456', email:'biuro@demofirma.pl',
      website:'www.demofirma.pl', bankAccount:'PL61 1090 1014 0000 0712 1981 2874',
      logo:'', theme:'#f0a500', vat:23,
      footer:'DziÄ™kujemy za zaufanie! Realizujemy zlecenia na terenie caÅ‚ej Polski.'
    });
    initDefaultPricing('demo');
    initDemoData('demo');
  }
  loginUser(demo);
}

function loginUser(user) {
  currentUser = user;
  DB.set('session', user.id);
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  const initials = (user.company||user.email).substring(0,1).toUpperCase();
  document.getElementById('user-avatar-btn').textContent = initials;
  showPage('dashboard');
  toast(`Witaj! ğŸ‘‹`,'success');
}

function logout() {
  DB.set('session', null);
  currentUser = null;
  location.reload();
}

function showUserMenu() {
  showModal(`
    <div class="modal-handle"></div>
    <div class="modal-body">
      <div style="text-align:center;padding:10px 0 20px">
        <div style="width:60px;height:60px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:var(--ink);margin:0 auto 12px;font-family:'Syne',sans-serif">${(currentUser.company||'U').substring(0,1).toUpperCase()}</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px">${currentUser.company||'UÅ¼ytkownik'}</div>
        <div style="color:var(--dim);font-size:13px;margin-top:4px">${currentUser.email}</div>
      </div>
      <button class="btn btn-red btn-full" onclick="closeModal();logout()">ğŸšª Wyloguj siÄ™</button>
    </div>
  `);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initDefaultPricing(uid) {
  DB.set('pricing_'+uid, {
    szlifowanie:8, gruntowanie_sciany:4, gladz:22, grunt_malowanie:5, malowanie:12,
    plytki_small:85, plytki_medium:110, plytki_large:145,
    gruntowanie_plytki:5, izolacja:25, cokoliki:28, silikon:18, naroznik_45:35, otwor_plytka:45,
    zabudowy_gk:95, sufit_prosty:75, sufit_wielopoziomowy:135,
    szpachlowanie_laczen:12, tasmy:8, narozniki_gk:15, okno_dachowe:280, parapety:150
  });
}

function initDemoData(uid) {
  DB.save('clients_'+uid, [
    { id:'c1', name:'Jan Kowalski', phone:'+48 500 111 222', email:'jan@example.com', address:'ul. Kwiatowa 5, Warszawa', nip:'', notes:'StaÅ‚y klient, polecony przez znajomych', created:'2024-09-10' },
    { id:'c2', name:'Anna Nowak-WiÅ›niewska', phone:'+48 601 333 444', email:'anna@example.com', address:'ul. RÃ³Å¼ana 12, KrakÃ³w', nip:'987-654-32-10', notes:'', created:'2024-10-15' },
    { id:'c3', name:'Firma XYZ Sp. z o.o.', phone:'+48 22 123 45 67', email:'kontakt@xyz.pl', address:'ul. PrzemysÅ‚owa 88, ÅÃ³dÅº', nip:'111-222-33-44', notes:'Projekt biurowy', created:'2024-11-01' }
  ]);
  DB.save('quotes_'+uid, [
    {
      id:'q1', number:'WYC/2024/001', clientId:'c1', clientName:'Jan Kowalski',
      clientPhone:'+48 500 111 222', address:'ul. Kwiatowa 5, Warszawa',
      date:'2024-10-10', validTo:'2024-11-10', status:'zaakceptowana', notes:'Remont Å‚azienki â€” kompleksowy',
      walls:{szlifowanie:20,gruntowanie:20,gladz:20,grunt_malowanie:20,malowanie:20,malowanie_warstwy:2},
      tiles:{small:0,medium:18,large:0,gruntowanie:18,izolacja:18,cokoliki:14,silikon:10,naroznik:6,otwory:3},
      gk:{zabudowy:0,sufit_prosty:0,sufit_wielopoziomowy:0,szpachlowanie:0,tasmy:0,narozniki:0,okna:0,parapety:0},
      custom:[], discount:5, vat:23, margin:0, created:'2024-10-10'
    },
    {
      id:'q2', number:'WYC/2024/002', clientId:'c2', clientName:'Anna Nowak-WiÅ›niewska',
      clientPhone:'+48 601 333 444', address:'ul. RÃ³Å¼ana 12, KrakÃ³w',
      date:'2024-11-20', validTo:'2024-12-20', status:'wysÅ‚ana', notes:'Salon + kuchnia',
      walls:{szlifowanie:55,gruntowanie:55,gladz:55,grunt_malowanie:55,malowanie:55,malowanie_warstwy:2},
      tiles:{small:22,medium:0,large:0,gruntowanie:22,izolacja:0,cokoliki:18,silikon:8,naroznik:4,otwory:2},
      gk:{zabudowy:12,sufit_prosty:38,sufit_wielopoziomowy:0,szpachlowanie:28,tasmy:28,narozniki:22,okna:0,parapety:2},
      custom:[{desc:'DemontaÅ¼ starej zabudowy',qty:12,unit:'mÂ²',price:18,total:216}],
      discount:0, vat:23, margin:8, created:'2024-11-20'
    },
    {
      id:'q3', number:'WYC/2024/003', clientId:'c3', clientName:'Firma XYZ Sp. z o.o.',
      clientPhone:'+48 22 123 45 67', address:'ul. PrzemysÅ‚owa 88, ÅÃ³dÅº',
      date:'2024-12-01', validTo:'2025-01-01', status:'robocza', notes:'Projekt biurowy â€” open space',
      walls:{szlifowanie:120,gruntowanie:120,gladz:120,grunt_malowanie:120,malowanie:120,malowanie_warstwy:2},
      tiles:{small:0,medium:0,large:45,gruntowanie:45,izolacja:0,cokoliki:0,silikon:0,naroznik:12,otwory:8},
      gk:{zabudowy:35,sufit_prosty:80,sufit_wielopoziomowy:0,szpachlowanie:60,tasmy:60,narozniki:45,okna:0,parapety:4},
      custom:[{desc:'Transport materiaÅ‚Ã³w',qty:1,unit:'ryczaÅ‚t',price:850,total:850}],
      discount:10, vat:23, margin:12, created:'2024-12-01'
    }
  ]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const uid = () => currentUser?.id;
const genId = () => Date.now().toString(36)+Math.random().toString(36).substr(2,5);
const today = () => new Date().toISOString().split('T')[0];
const dateAdd = (d,n) => { const dt=new Date(d); dt.setDate(dt.getDate()+n); return dt.toISOString().split('T')[0]; };
const fmt = n => Number(n||0).toLocaleString('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2})+' zÅ‚';
const fmtN = n => Number(n||0).toFixed(2);
const getCompany = () => DB.get('company_'+uid()) || {};
const getPricing = () => DB.get('pricing_'+uid()) || {};
const getClients = () => DB.arr('clients_'+uid());
const getQuotes = () => DB.arr('quotes_'+uid());
const saveClients = v => DB.save('clients_'+uid(),v);
const saveQuotes = v => DB.save('quotes_'+uid(),v);
const genNumber = () => { const q=getQuotes(); const y=new Date().getFullYear(); return `WYC/${y}/${String(q.length+1).padStart(3,'0')}`; };

function calcTotal(q) {
  const p = getPricing();
  let t = 0;
  t += (q.walls?.szlifowanie||0)*p.szlifowanie;
  t += (q.walls?.gruntowanie||0)*p.gruntowanie_sciany;
  t += (q.walls?.gladz||0)*p.gladz;
  t += (q.walls?.grunt_malowanie||0)*p.grunt_malowanie;
  t += (q.walls?.malowanie||0)*p.malowanie*(q.walls?.malowanie_warstwy||1);
  t += (q.tiles?.small||0)*p.plytki_small;
  t += (q.tiles?.medium||0)*p.plytki_medium;
  t += (q.tiles?.large||0)*p.plytki_large;
  t += (q.tiles?.gruntowanie||0)*p.gruntowanie_plytki;
  t += (q.tiles?.izolacja||0)*p.izolacja;
  t += (q.tiles?.cokoliki||0)*p.cokoliki;
  t += (q.tiles?.silikon||0)*p.silikon;
  t += (q.tiles?.naroznik||0)*p.naroznik_45;
  t += (q.tiles?.otwory||0)*p.otwor_plytka;
  t += (q.gk?.zabudowy||0)*p.zabudowy_gk;
  t += (q.gk?.sufit_prosty||0)*p.sufit_prosty;
  t += (q.gk?.sufit_wielopoziomowy||0)*p.sufit_wielopoziomowy;
  t += (q.gk?.szpachlowanie||0)*p.szpachlowanie_laczen;
  t += (q.gk?.tasmy||0)*p.tasmy;
  t += (q.gk?.narozniki||0)*p.narozniki_gk;
  t += (q.gk?.okna||0)*p.okno_dachowe;
  t += (q.gk?.parapety||0)*p.parapety;
  (q.custom||[]).forEach(c => t += c.total||0);
  t *= (1+(q.margin||0)/100);
  const disc = t*(q.discount||0)/100;
  const net = t - disc;
  const vat = net*(q.vat||23)/100;
  return { net, vat, gross: net+vat };
}

function statusBadge(s) {
  const labels = {robocza:'Robocza',wysÅ‚ana:'WysÅ‚ana',zaakceptowana:'Zaakceptowana',odrzucona:'Odrzucona'};
  return `<span class="badge badge-${s}">${labels[s]||s}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activePage = 'dashboard';
let editingQuote = null;
let customItems = [];

function showPage(page, data=null) {
  activePage = page;
  if (data) editingQuote = data; else if (page!=='new-quote') editingQuote = null;
  document.querySelectorAll('.nav-item[data-page],.desktop-nav-item[data-page]').forEach(b => b.classList.toggle('active', b.dataset.page===page));
  const renders = { dashboard:renderDashboard, quotes:renderQuotes, 'new-quote':renderNewQuote, clients:renderClients, pricing:renderPricing, settings:renderSettings };
  if (renders[page]) renders[page](data);
  window.scrollTo(0,0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  const quotes = getQuotes();
  const totals = quotes.map(q => calcTotal(q));
  const totalGross = totals.reduce((s,t)=>s+t.gross,0);
  const totalNet = totals.reduce((s,t)=>s+t.net,0);
  const accepted = quotes.filter(q=>q.status==='zaakceptowana').length;
  const avg = quotes.length ? totalNet/quotes.length : 0;
  const months = ['Sty','Lut','Mar','Kwi','Maj','Cze','Lip','Sie','Wrz','PaÅº','Lis','Gru'];
  const mData = new Array(12).fill(0);
  quotes.forEach((q,i) => { const m=new Date(q.date||q.created||today()).getMonth(); mData[m]+=totals[i].gross; });
  const recent = [...quotes].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  const company = getCompany();

  document.getElementById('page-content').innerHTML = `
    <div class="page-header">
      <div class="page-title">CzeÅ›Ä‡ ğŸ‘‹</div>
      <div class="page-sub">${company.name||'Twoja Firma'}</div>
    </div>

    <div class="stats-scroll">
      <div class="stat-card gold">
        <div class="stat-label">WartoÅ›Ä‡ brutto</div>
        <div class="stat-value">${totalGross >= 1000 ? (totalGross/1000).toFixed(1)+'k' : fmt(totalGross).replace(' zÅ‚','')}</div>
        <div class="stat-sub">zÅ‚ Å‚Ä…cznie</div>
      </div>
      <div class="stat-card lime">
        <div class="stat-label">Zaakceptowane</div>
        <div class="stat-value">${accepted}</div>
        <div class="stat-sub">z ${quotes.length} wycen</div>
      </div>
      <div class="stat-card blue">
        <div class="stat-label">Åšrednia wycena</div>
        <div class="stat-value">${avg>=1000?(avg/1000).toFixed(1)+'k':Math.round(avg)}</div>
        <div class="stat-sub">zÅ‚ netto</div>
      </div>
      <div class="stat-card" style="border-color:rgba(255,77,109,0.3);background:rgba(255,77,109,0.04)">
        <div class="stat-label">WskaÅºnik</div>
        <div class="stat-value" style="color:var(--red)">${quotes.length?Math.round(accepted/quotes.length*100):0}%</div>
        <div class="stat-sub">akceptacji</div>
      </div>
    </div>

    <div class="card" style="margin-bottom:16px">
      <div class="card-header">
        <div class="card-title">ğŸ“ˆ SprzedaÅ¼ miesiÄ™czna</div>
        <div style="font-size:12px;color:var(--muted)">${new Date().getFullYear()}</div>
      </div>
      <div class="card-body"><canvas id="chart-monthly" height="180"></canvas></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ• Ostatnie wyceny</div>
        <button class="btn btn-ghost btn-sm" onclick="showPage('quotes')">Wszystkie â†’</button>
      </div>
      <div class="card-body" style="padding:8px 12px">
        ${recent.length ? recent.map((q,i)=>{
          const t = totals[quotes.indexOf(q)] || calcTotal(q);
          return `<div class="quote-item" onclick="showPage('new-quote',getQuotes().find(x=>x.id==='${q.id}'))">
            <div class="quote-item-top">
              <div class="quote-number">${q.number}</div>
              <div class="quote-amount">${fmt(t.gross)}</div>
            </div>
            <div class="quote-client">ğŸ‘¤ ${q.clientName||'â€”'}</div>
            <div class="quote-bottom"><div class="quote-date">ğŸ“… ${q.date||'â€”'}</div>${statusBadge(q.status)}</div>
          </div>`;
        }).join('') : `<div class="empty"><div class="empty-icon">ğŸ“‹</div><h3>Brak wycen</h3><p>UtwÃ³rz pierwszÄ… wycenÄ™</p></div>`}
      </div>
    </div>

    <div style="height:20px"></div>
  `;

  setTimeout(()=>{
    const ctx = document.getElementById('chart-monthly');
    if (!ctx) return;
    new Chart(ctx, {
      type:'bar',
      data: {
        labels: months,
        datasets:[{ label:'Brutto', data:mData, backgroundColor: mData.map(v=>v>0?'rgba(240,165,0,0.8)':'rgba(42,58,78,0.5)'), borderRadius:6 }]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label: ctx => ' '+fmt(ctx.raw) } } },
        scales:{
          y:{ beginAtZero:true, ticks:{ color:'#4a5f74', callback: v=>v>=1000?(v/1000).toFixed(0)+'k':v }, grid:{ color:'rgba(42,58,78,0.5)' } },
          x:{ ticks:{ color:'#4a5f74' }, grid:{ display:false } }
        }
      }
    });
  },100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUOTES LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQuotes() {
  let quotes = getQuotes().sort((a,b)=>new Date(b.date)-new Date(a.date));
  let filter = 'all', search = '';

  const render = () => {
    let f = quotes.filter(q=>{
      const ms = filter==='all'||q.status===filter;
      const mq = !search||(q.number+q.clientName+q.address).toLowerCase().includes(search.toLowerCase());
      return ms&&mq;
    });
    document.getElementById('quotes-list').innerHTML = f.length ? f.map(q=>{
      const t = calcTotal(q);
      return `<div class="quote-item" onclick="editQuote('${q.id}')">
        <div class="quote-item-top">
          <div class="quote-number">${q.number}</div>
          <div class="quote-amount">${fmt(t.gross)}</div>
        </div>
        <div class="quote-client">ğŸ‘¤ ${q.clientName||'â€”'} Â· ğŸ“ ${(q.address||'â€”').split(',')[0]}</div>
        <div class="quote-bottom">
          <div class="quote-date">ğŸ“… ${q.date||'â€”'}</div>
          <div style="display:flex;gap:8px;align-items:center">
            ${statusBadge(q.status)}
            <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();generatePDF('${q.id}')">ğŸ“„</button>
            <button class="btn btn-red btn-sm" onclick="event.stopPropagation();delQuote('${q.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
      </div>`;
    }).join('') : `<div class="empty"><div class="empty-icon">ğŸ”</div><h3>Brak wynikÃ³w</h3><p>ZmieÅ„ filtry lub utwÃ³rz nowÄ… wycenÄ™</p></div>`;
  };

  document.getElementById('page-content').innerHTML = `
    <div class="page-header">
      <div class="page-title">Wyceny</div>
      <div class="page-sub">${getQuotes().length} Å‚Ä…cznie</div>
    </div>
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input placeholder="Szukaj..." oninput="search=this.value;render()">
    </div>
    <div class="filter-chips">
      ${['all','robocza','wysÅ‚ana','zaakceptowana','odrzucona'].map(s=>`
        <button class="chip ${s==='all'?'active':''}" onclick="filter='${s}';document.querySelectorAll('.chip').forEach((c,i)=>c.classList.toggle('active',i===${['all','robocza','wysÅ‚ana','zaakceptowana','odrzucona'].indexOf(s)}));render()">${s==='all'?'Wszystkie':s.charAt(0).toUpperCase()+s.slice(1)}</button>
      `).join('')}
    </div>
    <div id="quotes-list"></div>
    <button class="btn btn-gold btn-full" style="margin-top:8px" onclick="showPage('new-quote')">âœï¸ Nowa Wycena</button>
    <div style="height:20px"></div>
  `;
  window.filter = 'all'; window.search = ''; window.render = render;
  render();
}

function editQuote(id) { showPage('new-quote', getQuotes().find(q=>q.id===id)); }

function delQuote(id) {
  if (!confirm('UsunÄ…Ä‡ wycenÄ™?')) return;
  saveQuotes(getQuotes().filter(q=>q.id!==id));
  toast('Wycena usuniÄ™ta','success');
  renderQuotes();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW QUOTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let qData = {};

function initQData(existing) {
  if (existing) {
    qData = JSON.parse(JSON.stringify(existing));
    customItems = existing.custom||[];
  } else {
    const co = getCompany();
    qData = {
      id:genId(), number:genNumber(), clientId:'', clientName:'', clientPhone:'',
      address:'', date:today(), validTo:dateAdd(today(),30), status:'robocza', notes:'',
      walls:{szlifowanie:0,gruntowanie:0,gladz:0,grunt_malowanie:0,malowanie:0,malowanie_warstwy:1},
      tiles:{small:0,medium:0,large:0,gruntowanie:0,izolacja:0,cokoliki:0,silikon:0,naroznik:0,otwory:0},
      gk:{zabudowy:0,sufit_prosty:0,sufit_wielopoziomowy:0,szpachlowanie:0,tasmy:0,narozniki:0,okna:0,parapety:0},
      custom:[], discount:0, vat:co.vat||23, margin:0, created:today()
    };
    customItems = [];
  }
}

function renderNewQuote(existing=null) {
  initQData(existing);
  const clients = getClients();
  const p = getPricing();
  const isEdit = !!existing;

  document.getElementById('page-content').innerHTML = `
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="page-title">${isEdit?'Edytuj WycenÄ™':'Nowa Wycena'}</div>
        <div class="page-sub">${qData.number}</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="showPage('quotes')">â† WrÃ³Ä‡</button>
    </div>

    <!-- PODSTAWOWE DANE -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-header"><div class="card-title">ğŸ“Œ Dane podstawowe</div></div>
      <div class="card-body">
        <div class="form-group">
          <label class="form-label">Numer wyceny</label>
          <input class="form-input" id="q-num" value="${qData.number}">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="form-group">
            <label class="form-label">Data</label>
            <input class="form-input" type="date" id="q-date" value="${qData.date}">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="q-status">
              ${['robocza','wysÅ‚ana','zaakceptowana','odrzucona'].map(s=>`<option value="${s}" ${qData.status===s?'selected':''}>${s.charAt(0).toUpperCase()+s.slice(1)}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Klient</label>
          <select class="form-select" id="q-client" onchange="onClientSelect(this.value)">
            <option value="">-- Wybierz klienta --</option>
            ${clients.map(c=>`<option value="${c.id}" ${qData.clientId===c.id?'selected':''}>${c.name}</option>`).join('')}
            <option value="__new__">+ Dodaj nowego klienta</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ImiÄ™ / Firma</label>
          <input class="form-input" id="q-cname" value="${qData.clientName}" placeholder="Jan Kowalski">
        </div>
        <div class="form-group">
          <label class="form-label">Adres inwestycji</label>
          <input class="form-input" id="q-addr" value="${qData.address||''}" placeholder="ul. PrzykÅ‚adowa 1, Warszawa">
        </div>
        <div class="form-group">
          <label class="form-label">Notatki</label>
          <input class="form-input" id="q-notes" value="${qData.notes||''}" placeholder="Opis zlecenia...">
        </div>
      </div>
    </div>

    <!-- PARAMETRY -->
    <div class="params-row">
      <div class="param-box">
        <div class="param-label">VAT %</div>
        <input class="param-input" type="number" id="q-vat" value="${qData.vat}" min="0" max="100" oninput="recalc()">
      </div>
      <div class="param-box">
        <div class="param-label">Rabat %</div>
        <input class="param-input" type="number" id="q-disc" value="${qData.discount}" min="0" max="100" oninput="recalc()">
      </div>
      <div class="param-box">
        <div class="param-label">MarÅ¼a %</div>
        <input class="param-input" type="number" id="q-margin" value="${qData.margin}" min="0" max="200" oninput="recalc()">
      </div>
    </div>

    <!-- SEKCJA A: ÅšCIANY -->
    <div class="section-block">
      <div class="section-header" onclick="toggleSec('sec-walls')">
        <div class="section-header-left"><span>ğŸ </span><h3>A. Przygotowanie Åšcian</h3></div>
        <span class="section-total-badge" id="t-walls">0,00 zÅ‚</span>
      </div>
      <div class="section-body" id="sec-walls">
        <div class="section-row" style="background:var(--ink3);border-bottom:1px solid var(--steel)">
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Pozycja</div>
          <div style="display:grid;grid-template-columns:72px 22px 72px 70px;gap:8px;text-align:right">
            <div style="font-size:10px;color:var(--muted)">IloÅ›Ä‡</div>
            <div style="font-size:10px;color:var(--muted)">J.m</div>
            <div style="font-size:10px;color:var(--muted)">C.jedn</div>
            <div style="font-size:10px;color:var(--muted)">Razem</div>
          </div>
        </div>
        ${wallRow('szlifowanie','Szlifowanie Å›cian','mÂ²',p.szlifowanie)}
        ${wallRow('gruntowanie','Gruntowanie','mÂ²',p.gruntowanie_sciany)}
        ${wallRow('gladz','GÅ‚adÅº szpachlowa','mÂ²',p.gladz)}
        ${wallRow('grunt_malowanie','Grunt przed malowaniem','mÂ²',p.grunt_malowanie)}
        ${wallRowMalowanie(p.malowanie)}
      </div>
    </div>

    <!-- SEKCJA B: PÅYTKI -->
    <div class="section-block">
      <div class="section-header" onclick="toggleSec('sec-tiles')">
        <div class="section-header-left"><span>ğŸŸ¦</span><h3>B. Roboty PÅ‚ytkarskie</h3></div>
        <span class="section-total-badge" id="t-tiles">0,00 zÅ‚</span>
      </div>
      <div class="section-body" id="sec-tiles" style="display:none">
        ${tiRow('small','PÅ‚ytki do 60Ã—60 cm','mÂ²',p.plytki_small)}
        ${tiRow('medium','PÅ‚ytki 60Ã—120 cm','mÂ²',p.plytki_medium)}
        ${tiRow('large','PÅ‚ytki pow. 120 cm','mÂ²',p.plytki_large)}
        ${tiRow('gruntowanie','Gruntowanie pod pÅ‚ytki','mÂ²',p.gruntowanie_plytki)}
        ${tiRow('izolacja','Hydroizolacja','mÂ²',p.izolacja)}
        ${tiRow('cokoliki','CokoÅ‚ki / listwy','mb',p.cokoliki)}
        ${tiRow('silikon','Silikon','mb',p.silikon)}
        ${tiRow('naroznik','NaroÅ¼nik 45Â°','mb',p.naroznik_45)}
        ${tiRow('otwory','Otwory w pÅ‚ytce','szt',p.otwor_plytka)}
      </div>
    </div>

    <!-- SEKCJA C: GK -->
    <div class="section-block">
      <div class="section-header" onclick="toggleSec('sec-gk')">
        <div class="section-header-left"><span>ğŸ§±</span><h3>C. Zabudowy GK</h3></div>
        <span class="section-total-badge" id="t-gk">0,00 zÅ‚</span>
      </div>
      <div class="section-body" id="sec-gk" style="display:none">
        ${gkRow('zabudowy','Zabudowy GK','mÂ²',p.zabudowy_gk)}
        ${gkRow('sufit_prosty','Sufit prosty','mÂ²',p.sufit_prosty)}
        ${gkRow('sufit_wielopoziomowy','Sufit wielopoziomowy','mÂ²',p.sufit_wielopoziomowy)}
        ${gkRow('szpachlowanie','Szpachlowanie Å‚Ä…czeÅ„','mb',p.szpachlowanie_laczen)}
        ${gkRow('tasmy','TaÅ›my amerykaÅ„skie','mb',p.tasmy)}
        ${gkRow('narozniki','NaroÅ¼niki GK','mb',p.narozniki_gk)}
        ${gkRow('okna','Okno dachowe (obrÃ³bka)','szt',p.okno_dachowe)}
        ${gkRow('parapety','Parapety','szt',p.parapety)}
      </div>
    </div>

    <!-- WÅASNE POZYCJE -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-header">
        <div class="card-title">â• WÅ‚asne pozycje</div>
        <button class="btn btn-ghost btn-sm" onclick="addCI()">+ Dodaj</button>
      </div>
      <div class="card-body" id="custom-list">${renderCI()}</div>
    </div>

    <!-- PODSUMOWANIE -->
    <div class="summary-box" style="margin-bottom:14px">
      <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px">Podsumowanie</div>
      <div class="sum-row"><span class="sum-label">ğŸ  Åšciany:</span><span class="sum-value" id="s-walls">â€”</span></div>
      <div class="sum-row"><span class="sum-label">ğŸŸ¦ PÅ‚ytki:</span><span class="sum-value" id="s-tiles">â€”</span></div>
      <div class="sum-row"><span class="sum-label">ğŸ§± GK:</span><span class="sum-value" id="s-gk">â€”</span></div>
      <div class="sum-row"><span class="sum-label">â• WÅ‚asne:</span><span class="sum-value" id="s-custom">â€”</span></div>
      <div class="sum-divider"></div>
      <div class="sum-row"><span class="sum-label">MarÅ¼a (<span id="s-mpct">0</span>%):</span><span class="sum-value" id="s-mval">â€”</span></div>
      <div class="sum-row"><span class="sum-label">Rabat (<span id="s-dpct">0</span>%):</span><span class="sum-value" id="s-dval" style="color:var(--red)">â€”</span></div>
      <div class="sum-row"><span class="sum-label">Netto:</span><span class="sum-value" id="s-netto">â€”</span></div>
      <div class="sum-row"><span class="sum-label">VAT (<span id="s-vpct">23</span>%):</span><span class="sum-value" id="s-vval">â€”</span></div>
      <div class="sum-divider"></div>
      <div class="sum-total">
        <span class="sum-total-label">BRUTTO</span>
        <span class="sum-total-value" id="s-brutto">0,00 zÅ‚</span>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px">
      <button class="btn btn-ghost btn-full" onclick="saveQuote()">ğŸ’¾ Zapisz</button>
      <button class="btn btn-gold btn-full" onclick="saveAndPDF()">ğŸ“„ PDF</button>
    </div>
    <div style="height:20px"></div>
  `;
  recalc();
}

function wallRow(f, label, unit, price) {
  const v = qData.walls?.[f]||0, pr = qData.walls?.[f+'_price']||price||0;
  return `<div class="section-row">
    <div class="section-row-name">${label}</div>
    <div class="section-row-inputs">
      <input class="section-input" type="number" id="w-${f}" value="${v}" min="0" step="0.5" oninput="recalc()">
      <span class="section-unit">${unit}</span>
      <input class="section-input" type="number" id="w-${f}-p" value="${pr}" min="0" step="0.5" oninput="recalc()">
      <div class="section-row-total" id="w-${f}-t">0,00</div>
    </div>
  </div>`;
}
function wallRowMalowanie(price) {
  const v = qData.walls?.malowanie||0, w = qData.walls?.malowanie_warstwy||1, pr = qData.walls?.malowanie_price||price||0;
  return `<div class="section-row">
    <div class="section-row-name">Malowanie (warstwy: <input type="number" id="w-mw" value="${w}" min="1" max="5" style="width:36px;background:none;border:none;color:var(--gold);font-weight:700;font-family:'Syne',sans-serif;font-size:13px;text-align:center;outline:none" oninput="recalc()">)</div>
    <div class="section-row-inputs">
      <input class="section-input" type="number" id="w-malowanie" value="${v}" min="0" step="0.5" oninput="recalc()">
      <span class="section-unit">mÂ²</span>
      <input class="section-input" type="number" id="w-malowanie-p" value="${pr}" min="0" step="0.5" oninput="recalc()">
      <div class="section-row-total" id="w-malowanie-t">0,00</div>
    </div>
  </div>`;
}
function tiRow(f, label, unit, price) {
  const v = qData.tiles?.[f]||0, pr = qData.tiles?.[f+'_price']||price||0;
  return `<div class="section-row">
    <div class="section-row-name">${label}</div>
    <div class="section-row-inputs">
      <input class="section-input" type="number" id="ti-${f}" value="${v}" min="0" step="0.5" oninput="recalc()">
      <span class="section-unit">${unit}</span>
      <input class="section-input" type="number" id="ti-${f}-p" value="${pr}" min="0" step="0.5" oninput="recalc()">
      <div class="section-row-total" id="ti-${f}-t">0,00</div>
    </div>
  </div>`;
}
function gkRow(f, label, unit, price) {
  const v = qData.gk?.[f]||0, pr = qData.gk?.[f+'_price']||price||0;
  return `<div class="section-row">
    <div class="section-row-name">${label}</div>
    <div class="section-row-inputs">
      <input class="section-input" type="number" id="gk-${f}" value="${v}" min="0" step="0.5" oninput="recalc()">
      <span class="section-unit">${unit}</span>
      <input class="section-input" type="number" id="gk-${f}-p" value="${pr}" min="0" step="0.5" oninput="recalc()">
      <div class="section-row-total" id="gk-${f}-t">0,00</div>
    </div>
  </div>`;
}

function toggleSec(id) { const el=document.getElementById(id); if(el) el.style.display=el.style.display==='none'?'':'none'; }

function recalc() {
  const n = id => parseFloat(document.getElementById(id)?.value||0);
  const wFields = ['szlifowanie','gruntowanie','gladz','grunt_malowanie'];
  const tiFields = ['small','medium','large','gruntowanie','izolacja','cokoliki','silikon','naroznik','otwory'];
  const gkFields = ['zabudowy','sufit_prosty','sufit_wielopoziomowy','szpachlowanie','tasmy','narozniki','okna','parapety'];

  let sw=0, st=0, sg=0;
  wFields.forEach(f => { const t=n(`w-${f}`)*n(`w-${f}-p`); const el=document.getElementById(`w-${f}-t`); if(el) el.textContent=fmtN(t); sw+=t; });
  const mt=n('w-malowanie')*n('w-malowanie-p')*(n('w-mw')||1); const mel=document.getElementById('w-malowanie-t'); if(mel) mel.textContent=fmtN(mt); sw+=mt;
  tiFields.forEach(f => { const t=n(`ti-${f}`)*n(`ti-${f}-p`); const el=document.getElementById(`ti-${f}-t`); if(el) el.textContent=fmtN(t); st+=t; });
  gkFields.forEach(f => { const t=n(`gk-${f}`)*n(`gk-${f}-p`); const el=document.getElementById(`gk-${f}-t`); if(el) el.textContent=fmtN(t); sg+=t; });
  const sc = customItems.reduce((a,c)=>a+(c.total||0),0);

  const tw=document.getElementById('t-walls'); if(tw) tw.textContent=fmt(sw);
  const tt=document.getElementById('t-tiles'); if(tt) tt.textContent=fmt(st);
  const tg=document.getElementById('t-gk'); if(tg) tg.textContent=fmt(sg);

  const sub=sw+st+sg+sc;
  const margin=n('q-margin'), disc=n('q-disc'), vat=n('q-vat')||23;
  const afterMargin=sub*(1+margin/100), marginVal=afterMargin-sub;
  const discVal=afterMargin*disc/100, net=afterMargin-discVal;
  const vatVal=net*vat/100, gross=net+vatVal;

  const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
  set('s-walls',fmt(sw)); set('s-tiles',fmt(st)); set('s-gk',fmt(sg)); set('s-custom',fmt(sc));
  set('s-mpct',margin); set('s-mval',fmt(marginVal)); set('s-dpct',disc);
  set('s-dval','- '+fmt(discVal)); set('s-netto',fmt(net)); set('s-vpct',vat);
  set('s-vval',fmt(vatVal)); set('s-brutto',fmt(gross));
}

function renderCI() {
  if(!customItems.length) return `<div style="text-align:center;padding:20px 0;color:var(--muted);font-size:13px">Kliknij "+ Dodaj" aby dodaÄ‡ wÅ‚asnÄ… pozycjÄ™</div>`;
  return customItems.map((c,i)=>`<div class="custom-row">
    <input class="ci" value="${c.desc}" placeholder="Opis" oninput="customItems[${i}].desc=this.value">
    <input class="ci" type="number" value="${c.qty}" placeholder="IloÅ›Ä‡" oninput="customItems[${i}].qty=parseFloat(this.value||0);customItems[${i}].total=customItems[${i}].qty*customItems[${i}].price;recalc()">
    <input class="ci" value="${c.unit}" placeholder="j.m." oninput="customItems[${i}].unit=this.value">
    <input class="ci" type="number" value="${c.price}" placeholder="Cena" oninput="customItems[${i}].price=parseFloat(this.value||0);customItems[${i}].total=customItems[${i}].qty*customItems[${i}].price;recalc()">
    <button class="ci-del" onclick="customItems.splice(${i},1);document.getElementById('custom-list').innerHTML=renderCI();recalc()">âœ•</button>
  </div>`).join('');
}

function addCI() {
  customItems.push({desc:'',qty:1,unit:'mÂ²',price:0,total:0});
  document.getElementById('custom-list').innerHTML=renderCI();
  recalc();
}

function onClientSelect(id) {
  if (id==='__new__') { showClientModal(); return; }
  const c = getClients().find(x=>x.id===id);
  if (c) {
    const cn=document.getElementById('q-cname'); if(cn) cn.value=c.name;
    const ca=document.getElementById('q-addr'); if(ca) ca.value=c.address||'';
  }
}

function getQFromForm() {
  const n=id=>parseFloat(document.getElementById(id)?.value||0);
  const v=id=>document.getElementById(id)?.value||'';
  return {
    ...qData, number:v('q-num'), clientId:v('q-client')||qData.clientId,
    clientName:v('q-cname'), address:v('q-addr'),
    date:v('q-date'), status:v('q-status'), notes:v('q-notes'),
    walls:{szlifowanie:n('w-szlifowanie'),gruntowanie:n('w-gruntowanie'),gladz:n('w-gladz'),grunt_malowanie:n('w-grunt_malowanie'),malowanie:n('w-malowanie'),malowanie_warstwy:n('w-mw')||1,szlifowanie_price:n('w-szlifowanie-p'),gruntowanie_price:n('w-gruntowanie-p'),gladz_price:n('w-gladz-p'),grunt_malowanie_price:n('w-grunt_malowanie-p'),malowanie_price:n('w-malowanie-p')},
    tiles:{small:n('ti-small'),medium:n('ti-medium'),large:n('ti-large'),gruntowanie:n('ti-gruntowanie'),izolacja:n('ti-izolacja'),cokoliki:n('ti-cokoliki'),silikon:n('ti-silikon'),naroznik:n('ti-naroznik'),otwory:n('ti-otwory'),small_price:n('ti-small-p'),medium_price:n('ti-medium-p'),large_price:n('ti-large-p'),gruntowanie_price:n('ti-gruntowanie-p'),izolacja_price:n('ti-izolacja-p'),cokoliki_price:n('ti-cokoliki-p'),silikon_price:n('ti-silikon-p'),naroznik_price:n('ti-naroznik-p'),otwory_price:n('ti-otwory-p')},
    gk:{zabudowy:n('gk-zabudowy'),sufit_prosty:n('gk-sufit_prosty'),sufit_wielopoziomowy:n('gk-sufit_wielopoziomowy'),szpachlowanie:n('gk-szpachlowanie'),tasmy:n('gk-tasmy'),narozniki:n('gk-narozniki'),okna:n('gk-okna'),parapety:n('gk-parapety'),zabudowy_price:n('gk-zabudowy-p'),sufit_prosty_price:n('gk-sufit_prosty-p'),sufit_wielopoziomowy_price:n('gk-sufit_wielopoziomowy-p'),szpachlowanie_price:n('gk-szpachlowanie-p'),tasmy_price:n('gk-tasmy-p'),narozniki_price:n('gk-narozniki-p'),okna_price:n('gk-okna-p'),parapety_price:n('gk-parapety-p')},
    custom:[...customItems], discount:n('q-disc'), vat:n('q-vat'), margin:n('q-margin'), created:qData.created||today()
  };
}

function saveQuote() {
  const q = getQFromForm();
  if (!q.clientName) { toast('Podaj nazwÄ™ klienta','error'); return null; }
  const t = calcTotal(q); q.totalNet=t.net; q.totalGross=t.gross;
  const quotes = getQuotes();
  const idx = quotes.findIndex(x=>x.id===q.id);
  if(idx>=0) quotes[idx]=q; else quotes.push(q);
  saveQuotes(quotes);
  toast('Wycena zapisana âœ“','success');
  return q;
}

function saveAndPDF() { const q=saveQuote(); if(q) generatePDF(q.id); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generatePDF(qId) {
  const q = getQuotes().find(x=>x.id===qId);
  if(!q){toast('Nie znaleziono wyceny','error');return;}
  const co = getCompany();
  const t = calcTotal(q);
  const p = getPricing();

  const buildLines = (section, items) => items.filter(x=>x[2]>0).map(x=>({section,name:x[0],unit:x[1],qty:x[2],price:x[3],total:x[2]*x[3]}));

  const wallLines = buildLines('A. Przygotowanie Åšcian',[
    ['Szlifowanie Å›cian','mÂ²',q.walls?.szlifowanie||0,(q.walls?.szlifowanie_price||p.szlifowanie)],
    ['Gruntowanie','mÂ²',q.walls?.gruntowanie||0,(q.walls?.gruntowanie_price||p.gruntowanie_sciany)],
    ['GÅ‚adÅº szpachlowa','mÂ²',q.walls?.gladz||0,(q.walls?.gladz_price||p.gladz)],
    ['Grunt przed malowaniem','mÂ²',q.walls?.grunt_malowanie||0,(q.walls?.grunt_malowanie_price||p.grunt_malowanie)],
    [`Malowanie (${q.walls?.malowanie_warstwy||1} warstwy)`,'mÂ²',q.walls?.malowanie||0,(q.walls?.malowanie_price||p.malowanie)*(q.walls?.malowanie_warstwy||1)],
  ]);
  const tileLines = buildLines('B. Roboty PÅ‚ytkarskie',[
    ['PÅ‚ytki do 60Ã—60 cm','mÂ²',q.tiles?.small||0,(q.tiles?.small_price||p.plytki_small)],
    ['PÅ‚ytki 60Ã—120 cm','mÂ²',q.tiles?.medium||0,(q.tiles?.medium_price||p.plytki_medium)],
    ['PÅ‚ytki pow. 120 cm','mÂ²',q.tiles?.large||0,(q.tiles?.large_price||p.plytki_large)],
    ['Gruntowanie pod pÅ‚ytki','mÂ²',q.tiles?.gruntowanie||0,(q.tiles?.gruntowanie_price||p.gruntowanie_plytki)],
    ['Hydroizolacja','mÂ²',q.tiles?.izolacja||0,(q.tiles?.izolacja_price||p.izolacja)],
    ['CokoÅ‚ki / listwy','mb',q.tiles?.cokoliki||0,(q.tiles?.cokoliki_price||p.cokoliki)],
    ['Silikon','mb',q.tiles?.silikon||0,(q.tiles?.silikon_price||p.silikon)],
    ['NaroÅ¼nik szlifowany 45Â°','mb',q.tiles?.naroznik||0,(q.tiles?.naroznik_price||p.naroznik_45)],
    ['Otwory w pÅ‚ytce','szt',q.tiles?.otwory||0,(q.tiles?.otwory_price||p.otwor_plytka)],
  ]);
  const gkLines = buildLines('C. Zabudowy GK',[
    ['Zabudowy GK','mÂ²',q.gk?.zabudowy||0,(q.gk?.zabudowy_price||p.zabudowy_gk)],
    ['Sufit prosty','mÂ²',q.gk?.sufit_prosty||0,(q.gk?.sufit_prosty_price||p.sufit_prosty)],
    ['Sufit wielopoziomowy','mÂ²',q.gk?.sufit_wielopoziomowy||0,(q.gk?.sufit_wielopoziomowy_price||p.sufit_wielopoziomowy)],
    ['Szpachlowanie Å‚Ä…czeÅ„','mb',q.gk?.szpachlowanie||0,(q.gk?.szpachlowanie_price||p.szpachlowanie_laczen)],
    ['TaÅ›my amerykaÅ„skie','mb',q.gk?.tasmy||0,(q.gk?.tasmy_price||p.tasmy)],
    ['NaroÅ¼niki GK','mb',q.gk?.narozniki||0,(q.gk?.narozniki_price||p.narozniki_gk)],
    ['ObrÃ³bka okna dachowego','szt',q.gk?.okna||0,(q.gk?.okna_price||p.okno_dachowe)],
    ['Parapety','szt',q.gk?.parapety||0,(q.gk?.parapety_price||p.parapety)],
  ]);
  const custLines = (q.custom||[]).map(c=>({section:'Pozycje Dodatkowe',name:c.desc,unit:c.unit||'szt',qty:c.qty,price:c.price,total:c.total}));

  const allLines = [...wallLines,...tileLines,...gkLines,...custLines];
  const grouped = {};
  allLines.forEach(l=>{if(!grouped[l.section])grouped[l.section]=[];grouped[l.section].push(l);});

  let rowNum=1;
  const tableRows = Object.entries(grouped).map(([sec,items])=>`
    <tr><td colspan="6" style="background:#0f1923;color:#f0a500;font-weight:700;font-size:11px;padding:8px 12px;letter-spacing:0.5px;text-transform:uppercase">${sec}</td></tr>
    ${items.map(item=>`<tr>
      <td style="color:#64748b;width:36px;text-align:center">${rowNum++}</td>
      <td style="font-weight:500">${item.name}</td>
      <td style="text-align:center;color:#64748b">${item.qty.toLocaleString('pl-PL',{maximumFractionDigits:2})}</td>
      <td style="text-align:center;color:#64748b;width:45px">${item.unit}</td>
      <td style="text-align:right;color:#64748b;width:90px">${item.price.toLocaleString('pl-PL',{minimumFractionDigits:2})} zÅ‚</td>
      <td style="text-align:right;font-weight:600;width:100px">${item.total.toLocaleString('pl-PL',{minimumFractionDigits:2})} zÅ‚</td>
    </tr>`).join('')}
  `).join('');

  const statLabels = {robocza:'Robocza',wysÅ‚ana:'WysÅ‚ana',zaakceptowana:'Zaakceptowana',odrzucona:'Odrzucona'};
  const statColors = {robocza:'#64748b',wysÅ‚ana:'#3b82f6',zaakceptowana:'#10b981',odrzucona:'#ef4444'};

  document.getElementById('pdf-content').innerHTML = `<div class="pdf-page">
    <!-- HEADER -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:24px;border-bottom:3px solid #0f1923;margin-bottom:24px">
      <div>
        ${co.logo?`<img src="${co.logo}" style="max-height:65px;max-width:180px;object-fit:contain;margin-bottom:10px;display:block">`:''}
        <div style="font-size:22px;font-weight:900;color:#0f1923;font-family:'Syne',sans-serif;letter-spacing:-0.5px">ğŸ—ï¸ Budowlany<span style="color:#f0a500">PRO</span></div>
        <div style="font-size:11px;color:#64748b;margin-top:3px">Profesjonalne UsÅ‚ugi Budowlano-WykoÅ„czeniowe</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:16px;font-weight:800;color:#0f1923">${co.name||'Twoja Firma'}</div>
        <div style="font-size:11px;color:#64748b;line-height:1.8;margin-top:4px">
          ${[co.address,co.phone?'Tel: '+co.phone:'',co.email?'E: '+co.email:'',co.nip?'NIP: '+co.nip:''].filter(Boolean).join('<br>')}
        </div>
      </div>
    </div>
    <!-- TITLE -->
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:18px;font-weight:900;color:#0f1923;font-family:'Syne',sans-serif">WYCENA PRAC BUDOWLANO-WYKOÅƒCZENIOWYCH</div>
      <div style="display:inline-flex;align-items:center;gap:10px;margin-top:8px">
        <span style="background:#0f1923;color:#f0a500;padding:4px 16px;border-radius:20px;font-size:13px;font-weight:700">${q.number}</span>
        <span style="background:${statColors[q.status]}20;color:${statColors[q.status]};border:1px solid ${statColors[q.status]}50;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase">${statLabels[q.status]||q.status}</span>
      </div>
    </div>
    <!-- META -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
      <div style="background:#f8fafc;border-radius:10px;padding:14px;border:1px solid #e2e8f0">
        <div style="font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px">Klient / Zleceniodawca</div>
        <div style="font-size:14px;font-weight:700;color:#0f1923">${q.clientName||'â€”'}</div>
        <div style="font-size:12px;color:#64748b;margin-top:4px;line-height:1.7">
          ${q.clientPhone?'ğŸ“ '+q.clientPhone+'<br>':''}
          ${q.address?'ğŸ“ '+q.address:''}
        </div>
      </div>
      <div style="background:#f8fafc;border-radius:10px;padding:14px;border:1px solid #e2e8f0">
        <div style="font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px">SzczegÃ³Å‚y</div>
        <div style="font-size:12px;color:#64748b;line-height:1.9">
          <b style="color:#0f1923">Data wystawienia:</b> ${q.date||today()}<br>
          <b style="color:#0f1923">WaÅ¼na do:</b> ${q.validTo||dateAdd(q.date||today(),30)}<br>
          ${q.notes?`<b style="color:#0f1923">Opis:</b> ${q.notes}`:''}
        </div>
      </div>
    </div>
    <!-- TABLE -->
    <table style="width:100%;border-collapse:collapse;margin-bottom:16px;font-size:12px">
      <thead><tr>
        <th style="background:#0f1923;color:#fff;padding:9px 12px;text-align:center;width:36px">#</th>
        <th style="background:#0f1923;color:#fff;padding:9px 12px;text-align:left">Opis pozycji</th>
        <th style="background:#0f1923;color:#fff;padding:9px 12px;text-align:center;width:60px">IloÅ›Ä‡</th>
        <th style="background:#0f1923;color:#fff;padding:9px 12px;text-align:center;width:45px">J.m.</th>
        <th style="background:#0f1923;color:#fff;padding:9px 12px;text-align:right;width:90px">C. jedn.</th>
        <th style="background:#0f1923;color:#fff;padding:9px 12px;text-align:right;width:100px">Razem netto</th>
      </tr></thead>
      <tbody>${tableRows||'<tr><td colspan="6" style="text-align:center;padding:20px;color:#94a3b8">Brak pozycji</td></tr>'}</tbody>
    </table>
    <!-- SUMMARY -->
    <div style="display:flex;justify-content:flex-end;margin-bottom:16px">
      <table style="font-size:13px;border:1px solid #e2e8f0;border-radius:10px;overflow:hidden;min-width:280px">
        <tr><td style="padding:9px 14px;color:#64748b;border-bottom:1px solid #f1f5f9">WartoÅ›Ä‡ netto robÃ³t:</td><td style="padding:9px 14px;text-align:right;font-weight:600;border-bottom:1px solid #f1f5f9">${fmt(t.net*(1+(q.discount||0)/100)/(1-(q.margin||0)/100/(1+(q.margin||0)/100)))}</td></tr>
        ${q.margin>0?`<tr><td style="padding:9px 14px;color:#64748b;border-bottom:1px solid #f1f5f9">MarÅ¼a (${q.margin}%):</td><td style="padding:9px 14px;text-align:right;font-weight:600;border-bottom:1px solid #f1f5f9">${fmt(t.net*q.margin/100)}</td></tr>`:''}
        ${q.discount>0?`<tr><td style="padding:9px 14px;color:#64748b;border-bottom:1px solid #f1f5f9">Rabat (${q.discount}%):</td><td style="padding:9px 14px;text-align:right;font-weight:600;color:#ef4444;border-bottom:1px solid #f1f5f9">- ${fmt(t.net*q.discount/100)}</td></tr>`:''}
        <tr><td style="padding:9px 14px;color:#64748b;border-bottom:1px solid #f1f5f9">WartoÅ›Ä‡ netto:</td><td style="padding:9px 14px;text-align:right;font-weight:600;border-bottom:1px solid #f1f5f9">${fmt(t.net)}</td></tr>
        <tr><td style="padding:9px 14px;color:#64748b;border-bottom:1px solid #f1f5f9">VAT (${q.vat}%):</td><td style="padding:9px 14px;text-align:right;font-weight:600;border-bottom:1px solid #f1f5f9">${fmt(t.vat)}</td></tr>
        <tr style="background:#0f1923"><td style="padding:12px 14px;color:#fff;font-size:14px;font-weight:800">RAZEM BRUTTO:</td><td style="padding:12px 14px;text-align:right;color:#f0a500;font-size:16px;font-weight:900">${fmt(t.gross)}</td></tr>
      </table>
    </div>
    ${q.notes?`<div style="background:#f8fafc;border-left:4px solid #0f1923;padding:10px 14px;border-radius:0 8px 8px 0;margin-bottom:16px;font-size:12px;color:#64748b"><b>Uwagi:</b> ${q.notes}</div>`:''}
    ${co.bankAccount?`<div style="background:#f8fafc;border-radius:8px;padding:10px 14px;font-size:11px;color:#64748b;margin-bottom:16px"><b>Dane do przelewu:</b> ${co.name} | Nr konta: ${co.bankAccount}</div>`:''}
    <!-- SIGNATURE -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:30px;padding-top:16px;border-top:1px solid #e2e8f0">
      <div style="text-align:center"><div style="border-bottom:1.5px solid #94a3b8;height:50px;margin-bottom:8px"></div><div style="font-size:11px;color:#64748b">Podpis Zleceniodawcy</div></div>
      <div style="text-align:center"><div style="border-bottom:1.5px solid #94a3b8;height:50px;margin-bottom:8px"></div><div style="font-size:11px;color:#64748b">PieczÄ…tka i podpis Wykonawcy</div></div>
    </div>
    <!-- FOOTER -->
    <div style="margin-top:24px;padding-top:14px;border-top:1px solid #e2e8f0;text-align:center;font-size:10px;color:#94a3b8;line-height:1.8">
      ${co.footer||'DziÄ™kujemy za zaufanie!'}<br>
      ${co.name} | ${co.phone||''} | ${co.email||''} | Wygenerowano: ${new Date().toLocaleDateString('pl-PL')}
    </div>
  </div>`;

  document.getElementById('pdf-overlay').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closePDF() {
  document.getElementById('pdf-overlay').style.display = 'none';
  document.body.style.overflow = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderClients() {
  let search = '';
  const rerender = () => {
    const clients = getClients().filter(c=>!search||c.name.toLowerCase().includes(search.toLowerCase())||(c.phone||'').includes(search));
    const quotes = getQuotes();
    document.getElementById('clients-list').innerHTML = clients.length ? clients.map(c=>{
      const cq = quotes.filter(q=>q.clientId===c.id);
      const total = cq.reduce((s,q)=>s+calcTotal(q).gross,0);
      return `<div class="client-item" onclick="openClientModal('${c.id}')">
        <div class="client-avatar">${c.name.substring(0,1).toUpperCase()}</div>
        <div class="client-info">
          <div class="client-name">${c.name}</div>
          <div class="client-contact">${c.phone||''} ${c.email?'Â· '+c.email:''}</div>
        </div>
        <div class="client-stats">
          <div class="client-count">${cq.length} wycen</div>
          <div class="client-total">${total>0?fmt(total):''}</div>
        </div>
      </div>`;
    }).join('') : `<div class="empty"><div class="empty-icon">ğŸ‘¥</div><h3>Brak klientÃ³w</h3><p>Dodaj pierwszego klienta</p></div>`;
  };

  document.getElementById('page-content').innerHTML = `
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="page-title">Klienci</div><div class="page-sub">${getClients().length} Å‚Ä…cznie</div></div>
      <button class="btn btn-gold btn-sm" onclick="openClientModal()">+ Dodaj</button>
    </div>
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input placeholder="Szukaj klienta..." oninput="search=this.value;rerender()">
    </div>
    <div id="clients-list"></div>
    <div style="height:20px"></div>
  `;
  window.search=''; window.rerender=rerender;
  rerender();
}

function openClientModal(id=null) {
  const c = id ? getClients().find(x=>x.id===id) : null;
  const quotes = id ? getQuotes().filter(q=>q.clientId===id) : [];
  showModal(`
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title">${c?'Edytuj Klienta':'Nowy Klient'}</div>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">ImiÄ™ / Firma *</label><input class="form-input" id="c-name" value="${c?.name||''}" placeholder="Jan Kowalski"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="form-group"><label class="form-label">Telefon</label><input class="form-input" id="c-phone" value="${c?.phone||''}" placeholder="+48 500..."></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="c-email" value="${c?.email||''}" placeholder="jan@..."></div>
      </div>
      <div class="form-group"><label class="form-label">Adres</label><input class="form-input" id="c-addr" value="${c?.address||''}" placeholder="ul. PrzykÅ‚adowa 1, Warszawa"></div>
      <div class="form-group"><label class="form-label">NIP</label><input class="form-input" id="c-nip" value="${c?.nip||''}" placeholder="123-456-78-90"></div>
      <div class="form-group"><label class="form-label">Notatki</label><input class="form-input" id="c-notes" value="${c?.notes||''}" placeholder="Uwagi o kliencie..."></div>
      ${quotes.length?`
        <div class="section-label">Historia wycen</div>
        ${quotes.map(q=>{const t=calcTotal(q);return`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--steel)">
          <div><div style="font-size:13px;font-weight:600">${q.number}</div><div style="font-size:11px;color:var(--muted)">${q.date}</div></div>
          <div style="display:flex;gap:8px;align-items:center">${statusBadge(q.status)}<span style="font-weight:700;color:var(--gold)">${fmt(t.gross)}</span><button class="btn btn-ghost btn-sm" onclick="closeModal();generatePDF('${q.id}')">ğŸ“„</button></div>
        </div>`}).join('')}
      `:''}
    </div>
    <div class="modal-footer">
      ${c?`<button class="btn btn-red" onclick="deleteClient('${c.id}')">ğŸ—‘ï¸</button>`:''}
      <button class="btn btn-ghost" onclick="closeModal()">Anuluj</button>
      <button class="btn btn-gold" style="flex:1" onclick="saveClient('${id||''}')">ğŸ’¾ Zapisz</button>
    </div>
  `);
}

function showClientModal() {
  openClientModal();
}

function saveClient(id) {
  const name = document.getElementById('c-name')?.value.trim();
  if(!name){toast('Podaj imiÄ™ klienta','error');return;}
  const clients = getClients();
  const client = { id:id||genId(), name, phone:document.getElementById('c-phone')?.value||'', email:document.getElementById('c-email')?.value||'', address:document.getElementById('c-addr')?.value||'', nip:document.getElementById('c-nip')?.value||'', notes:document.getElementById('c-notes')?.value||'', created:today() };
  if(id){const i=clients.findIndex(x=>x.id===id);if(i>=0)clients[i]=client;}else clients.push(client);
  saveClients(clients);
  closeModal();
  toast('Klient zapisany âœ“','success');
  if(activePage==='clients') renderClients();
}

function deleteClient(id) {
  if(!confirm('UsunÄ…Ä‡ klienta?'))return;
  saveClients(getClients().filter(c=>c.id!==id));
  closeModal();
  toast('Klient usuniÄ™ty','success');
  renderClients();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRICING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPricing() {
  const p = getPricing();
  const groups = [
    {title:'ğŸ  Przygotowanie Åšcian',items:[
      {k:'szlifowanie',l:'Szlifowanie Å›cian',u:'mÂ²'},{k:'gruntowanie_sciany',l:'Gruntowanie',u:'mÂ²'},
      {k:'gladz',l:'GÅ‚adÅº szpachlowa',u:'mÂ²'},{k:'grunt_malowanie',l:'Grunt przed malowaniem',u:'mÂ²'},{k:'malowanie',l:'Malowanie (1 warstwa)',u:'mÂ²'}
    ]},
    {title:'ğŸŸ¦ Roboty PÅ‚ytkarskie',items:[
      {k:'plytki_small',l:'PÅ‚ytki do 60Ã—60 cm',u:'mÂ²'},{k:'plytki_medium',l:'PÅ‚ytki 60Ã—120 cm',u:'mÂ²'},{k:'plytki_large',l:'PÅ‚ytki pow. 120 cm',u:'mÂ²'},
      {k:'gruntowanie_plytki',l:'Gruntowanie pod pÅ‚ytki',u:'mÂ²'},{k:'izolacja',l:'Hydroizolacja',u:'mÂ²'},{k:'cokoliki',l:'CokoÅ‚ki',u:'mb'},
      {k:'silikon',l:'Silikon',u:'mb'},{k:'naroznik_45',l:'NaroÅ¼nik 45Â°',u:'mb'},{k:'otwor_plytka',l:'Otwory w pÅ‚ytce',u:'szt'}
    ]},
    {title:'ğŸ§± Zabudowy GK',items:[
      {k:'zabudowy_gk',l:'Zabudowy GK',u:'mÂ²'},{k:'sufit_prosty',l:'Sufit prosty',u:'mÂ²'},{k:'sufit_wielopoziomowy',l:'Sufit wielopoziomowy',u:'mÂ²'},
      {k:'szpachlowanie_laczen',l:'Szpachlowanie Å‚Ä…czeÅ„',u:'mb'},{k:'tasmy',l:'TaÅ›my amÃ©ricaines',u:'mb'},{k:'narozniki_gk',l:'NaroÅ¼niki GK',u:'mb'},
      {k:'okno_dachowe',l:'ObrÃ³bka okna dachowego',u:'szt'},{k:'parapety',l:'Parapety',u:'szt'}
    ]}
  ];

  document.getElementById('page-content').innerHTML = `
    <div class="page-header"><div class="page-title">Cennik</div><div class="page-sub">DomyÅ›lne ceny jednostkowe</div></div>
    <div style="background:rgba(240,165,0,0.08);border:1px solid rgba(240,165,0,0.2);border-radius:var(--r);padding:12px 14px;margin-bottom:16px;font-size:12px;color:var(--dim)">ğŸ’¡ Ceny widoczne przy tworzeniu nowej wyceny. MoÅ¼esz je zmieniÄ‡ indywidualnie dla kaÅ¼dej wyceny.</div>
    ${groups.map(g=>`
      <div class="card" style="margin-bottom:14px">
        <div class="card-header"><div class="card-title">${g.title}</div></div>
        <div class="card-body" style="padding:12px">
          ${g.items.map(item=>`
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 6px;border-bottom:1px solid var(--steel)">
              <div style="font-size:13px;color:var(--ghost)">${item.l} <span style="color:var(--muted);font-size:11px">/ ${item.u}</span></div>
              <div style="display:flex;align-items:center;gap:6px">
                <input class="section-input" type="number" id="pr-${item.k}" value="${p[item.k]||0}" min="0" step="0.5" style="width:80px">
                <span style="font-size:12px;color:var(--muted)">zÅ‚</span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `).join('')}
    <button class="btn btn-gold btn-full" onclick="savePricing()">ğŸ’¾ Zapisz Cennik</button>
    <div style="height:20px"></div>
  `;

  window.savePricing = () => {
    const allItems = groups.flatMap(g=>g.items);
    const newP = {};
    allItems.forEach(item => { newP[item.k]=parseFloat(document.getElementById('pr-'+item.k)?.value||0); });
    DB.set('pricing_'+uid(), newP);
    toast('Cennik zapisany âœ“','success');
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings() {
  const co = getCompany();
  document.getElementById('page-content').innerHTML = `
    <div class="page-header"><div class="page-title">Ustawienia</div><div class="page-sub">Konfiguracja aplikacji</div></div>

    <div class="section-label">Firma</div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-body">
        <div class="form-group"><label class="form-label">Nazwa Firmy</label><input class="form-input" id="s-name" value="${co.name||''}"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="form-group"><label class="form-label">NIP</label><input class="form-input" id="s-nip" value="${co.nip||''}" placeholder="123-456-78-90"></div>
          <div class="form-group"><label class="form-label">VAT domyÅ›lny</label><input class="form-input" type="number" id="s-vat" value="${co.vat||23}" min="0" max="100"></div>
        </div>
        <div class="form-group"><label class="form-label">Adres</label><input class="form-input" id="s-addr" value="${co.address||''}" placeholder="ul. PrzykÅ‚adowa 1, Warszawa"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="form-group"><label class="form-label">Telefon</label><input class="form-input" id="s-phone" value="${co.phone||''}"></div>
          <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="s-email" value="${co.email||''}"></div>
        </div>
        <div class="form-group"><label class="form-label">Strona WWW</label><input class="form-input" id="s-web" value="${co.website||''}" placeholder="www.firma.pl"></div>
        <div class="form-group"><label class="form-label">Numer konta bankowego</label><input class="form-input" id="s-bank" value="${co.bankAccount||''}" placeholder="PL61 1090..."></div>
        <div class="form-group"><label class="form-label">Stopka na PDF</label><input class="form-input" id="s-footer" value="${co.footer||'DziÄ™kujemy za zaufanie!'}"></div>
      </div>
    </div>

    <div class="section-label">Logo firmy</div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-body">
        ${co.logo?`<img src="${co.logo}" style="max-height:80px;max-width:200px;object-fit:contain;border-radius:8px;border:1px solid var(--steel);padding:8px;display:block;margin-bottom:12px">`:'<div style="background:var(--ink3);border:2px dashed var(--steel);border-radius:10px;padding:30px;text-align:center;color:var(--muted);margin-bottom:12px">Brak logo</div>'}
        <input type="file" id="s-logo" accept="image/*" style="display:none" onchange="previewLogo(this)">
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('s-logo').click()">ğŸ“ Wybierz logo</button>
          ${co.logo?`<button class="btn btn-red btn-sm" onclick="removeLogo()">ğŸ—‘ï¸ UsuÅ„</button>`:''}
        </div>
        <div id="logo-preview" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="section-label">Backup danych</div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <button class="btn btn-ghost btn-full" onclick="exportData()">â¬‡ï¸ Eksportuj JSON</button>
          <div>
            <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(this)">
            <button class="btn btn-ghost btn-full" onclick="document.getElementById('import-file').click()">â¬†ï¸ Importuj JSON</button>
          </div>
        </div>
      </div>
    </div>

    <button class="btn btn-gold btn-full" onclick="saveSettings()">ğŸ’¾ Zapisz Ustawienia</button>

    <div class="section-label" style="margin-top:24px">Konto</div>
    <div class="settings-item" onclick="showUserMenu()">
      <div class="settings-icon" style="background:rgba(255,77,109,0.1)">ğŸ‘¤</div>
      <div class="settings-info"><div class="settings-title">${currentUser?.email||''}</div><div class="settings-sub">${currentUser?.company||''}</div></div>
      <div class="settings-arrow">â€º</div>
    </div>

    <div style="height:20px"></div>
  `;

  window.previewLogo = (input) => {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      window._logoData = e.target.result;
      document.getElementById('logo-preview').innerHTML = `<img src="${e.target.result}" style="max-height:70px;border-radius:8px;border:1px solid var(--steel);padding:6px">`;
    };
    reader.readAsDataURL(file);
  };

  window.removeLogo = () => {
    const co2=getCompany(); co2.logo=''; DB.set('company_'+uid(),co2);
    toast('Logo usuniÄ™te','success'); renderSettings();
  };

  window.saveSettings = () => {
    const data = {
      name:document.getElementById('s-name').value, nip:document.getElementById('s-nip').value,
      vat:parseInt(document.getElementById('s-vat').value)||23,
      address:document.getElementById('s-addr').value, phone:document.getElementById('s-phone').value,
      email:document.getElementById('s-email').value, website:document.getElementById('s-web').value,
      bankAccount:document.getElementById('s-bank').value, footer:document.getElementById('s-footer').value,
      logo: window._logoData || co.logo || '', theme: co.theme||'#f0a500'
    };
    DB.set('company_'+uid(), data);
    toast('Ustawienia zapisane âœ“','success');
  };

  window.exportData = () => {
    const data = { version:'1.0', exported:new Date().toISOString(), company:getCompany(), pricing:getPricing(), clients:getClients(), quotes:getQuotes() };
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `BudowlanyPRO_${today()}.json`;
    a.click();
    toast('Dane wyeksportowane âœ“','success');
  };

  window.importData = (input) => {
    const file = input.files[0]; if(!file) return;
    if(!confirm('Import zastÄ…pi obecne dane!')) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        if(data.company) DB.set('company_'+uid(),data.company);
        if(data.pricing) DB.set('pricing_'+uid(),data.pricing);
        if(data.clients) saveClients(data.clients);
        if(data.quotes) saveQuotes(data.quotes);
        toast('Import zakoÅ„czony âœ“','success');
      } catch { toast('BÅ‚Ä…d importu','error'); }
    };
    reader.readAsText(file);
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(html) {
  const existing = document.getElementById('modal-container');
  if(existing) existing.remove();
  const el = document.createElement('div');
  el.id = 'modal-container';
  el.innerHTML = `<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal">${html}</div></div>`;
  document.body.appendChild(el);
}

function closeModal() {
  const el = document.getElementById('modal-container');
  if(el) el.remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type='info') {
  const el = document.createElement('div');
  el.className = `toast-item ${type}`;
  const icons = {success:'âœ…',error:'âŒ',info:'â„¹ï¸'};
  el.innerHTML = `<span>${icons[type]}</span><span>${msg}</span>`;
  document.getElementById('toast-wrap').appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONLINE/OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('online',()=>{
  document.getElementById('sync-label').textContent='Online';
  document.querySelector('.sync-dot').style.background='var(--lime)';
});
window.addEventListener('offline',()=>{
  document.getElementById('sync-label').textContent='Offline';
  document.querySelector('.sync-dot').style.background='var(--gold)';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA MANIFEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const manifest = {
  name:'BudowlanyPRO', short_name:'BudowlanyPRO',
  description:'System wycen budowlano-wykoÅ„czeniowych',
  start_url:'/', display:'standalone',
  background_color:'#0a0f14', theme_color:'#0f1923',
  icons:[{src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="%230f1923"/><text y="0.9em" font-size="72" x="14">ğŸ—ï¸</text></svg>',sizes:'any',type:'image/svg+xml'}]
};
const blob = new Blob([JSON.stringify(manifest)],{type:'application/json'});
document.getElementById('manifest-link').href = URL.createObjectURL(blob);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const sessionId = DB.get('session');
if (sessionId) {
  const users = DB.arr('users');
  const user = users.find(u=>u.id===sessionId);
  if(user) loginUser(user);
}
</script>
</body>
</html>
